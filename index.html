<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1620" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- CSS (garde la police Noto Kufi Arabic dans ce fichier) -->
  <link rel="stylesheet" href="assets/css/noto-ar.css" />
  <link rel="stylesheet" href="assets/css/app.css" />

  <title>EDUFUN ‚Äî WordSearch Mini</title>
<link rel="preload" href="polices/NotoKufiArabe-R√©gulier.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="polices/NotoKufiArabe-Gras.woff2" as="font" type="font/woff2" crossorigin>
<style>
@font-face{
  font-family:"Noto Kufi Arabic";
  src:url("polices/NotoKufiArabe-R√©gulier.woff2") format("woff2");
  font-weight:400;
  font-style:normal;
  font-display:swap;
}
@font-face{
  font-family:"Noto Kufi Arabic";
  src:url("polices/NotoKufiArabe-Gras.woff2") format("woff2");
  font-weight:700;
  font-style:normal;
  font-display:swap;
}

/* activer uniquement en arabe / RTL */
html[lang="ar"],[dir="rtl"],:lang(ar){
  font-family:"Noto Kufi Arabic", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
}
</style>

  <style>
    :root{
      --bg:#0b1420; --panel:#0f1b2a; --ink:#e9f1ff; --muted:#a9bed8; --accent:#21c07a;
      --cell:#0a1524; --cell-sel:#1a7e4d; --cell-ok:#1aa75f; --border:#4d8ed1;
      --gap:8px; --shell-w:min(92vw,680px);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1420,#081019); color:var(--ink);
      font-family: Inter, system-ui, "Noto Kufi Arabic", sans-serif;
    }
    body[dir="rtl"]{font-family:"Noto Kufi Arabic", system-ui, sans-serif}

    .container{max-width:980px;margin-inline:auto;padding:16px}
    h1{margin:6px 0 14px;font-size:clamp(20px,3.6vw,34px)}
    .card{background:var(--panel);border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.35)}

    .controls{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .controls .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{color:var(--muted);font-size:14px}
    select,input[type="range"]{background:#0b1626;color:var(--ink);border:1px solid #254c7b;border-radius:10px;padding:6px 10px}
    button{background:var(--accent);color:#052016;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .header-bar{background:#0d1b2c;padding:10px;border-radius:10px;text-align:center;font-weight:800}

    .grid-shell{display:flex;justify-content:center}
    #grid-wrap{width:var(--shell-w);padding:12px;border:1px solid #24496e;border-radius:14px;background:#0e1826;margin:0 auto}
    #grid{display:grid;grid-template-columns:repeat(var(--N,14),1fr);gap:var(--gap);width:100%;touch-action:none}

    .cell{
      background:var(--cell); border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      color:#f1f6ff; font-weight:800; aspect-ratio:1/1;
      font-size: clamp(14px, calc( ((var(--shell-w) - (var(--N) - 1) * var(--gap)) / var(--N)) * 0.56 ), 48px);
      line-height:1; user-select:none; -webkit-user-select:none; -webkit-tap-highlight-color: transparent;
      white-space:nowrap; overflow:hidden; letter-spacing:0; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
    }
    body[dir="rtl"] .cell{
      font-size: clamp(13px, calc( ((var(--shell-w) - (var(--N) - 1) * var(--gap)) / var(--N)) * 0.52 ), 44px);
    }
    .cell.sel{background:var(--cell-sel);border-color:#2bd083}
    .cell.ok{background:var(--cell-ok);border-color:#3de58e;color:#fff}
    .cell.sol{outline:3px dashed #ffa726;outline-offset:-6px}

    .words{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;justify-content:center}
    .words .chip{background:#142944;border:1px dashed #274a77;color:#d4e6ff;padding:8px 12px;border-radius:999px;font-weight:700}
    .words .chip.ok{background:#0f3b24;border-color:#1f9d55;color:#bff6d1}

    .cont-africa{--cell-sel:#1a7e4d}
    .cont-europe{--cell-sel:#1f6fe0}
    .cont-asia{--cell-sel:#b84ce6}
    .cont-north_america{--cell-sel:#ff7a1a}
    .cont-south_america{--cell-sel:#ff4d6d}
    .cont-oceania{--cell-sel:#13b5b1}

    @media (max-width:560px){ .controls{grid-template-columns:1fr} }
  </style>

  <script>
    // Enregistrement du Service Worker (port√©e = dossier du site GitHub Pages)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</head>
<body>
<div class="container">
  <h1>üåç EDUFUN ‚Äî WordSearch Mini</h1>

  <div class="card">
    <div class="controls">
      <div class="row"><label>Continent :</label>
        <select id="continent">
          <option value="africa">Afrique</option>
          <option value="europe">Europe</option>
          <option value="asia">Asie</option>
          <option value="north_america">Am√©rique du Nord</option>
          <option value="south_america">Am√©rique du Sud</option>
          <option value="oceania">Oc√©anie</option>
        </select>
      </div>
      <div class="row"><label>Langue :</label>
        <select id="lang">
          <option value="fr">Fran√ßais</option>
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
      </div>
      <div class="row"><label>Taille :</label>
        <select id="size">
          <option>6</option><option>8</option><option>10</option>
          <option selected>14</option><option>12</option><option>16</option>
        </select>
      </div>
      <div class="row">
        <label><input type="checkbox" id="diag" checked> diagonales</label>
        <label><input type="checkbox" id="rev" checked> mots invers√©s</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="sound" checked> son (click)</label>
      </div>
      <div class="row"><label>Mots :</label>
        <input id="wordsCount" type="range" min="4" max="24" value="20">
        <span id="wordsCountLabel">20</span>
      </div>
    </div>

    <div class="actions">
      <button id="new">Nouvelle grille</button>
      <button id="toggleSol">Afficher les solutions</button>
    </div>

    <div id="titleBar" class="header-bar">‚Äî</div>

    <div class="grid-shell">
      <div id="grid-wrap" class="cont-africa">
        <div id="grid" style="--N:14"></div>
        <div id="words" class="words"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ======== Donn√©es ======== */
const DATA = {
  fr:{africa:["Alg√©rie","Tunisie","Maroc","Libye","√âgypte","Soudan","Kenya","Gabon","B√©nin","Ghana","Mali","Niger","Malawi","Namibie","Mozambique","Togo","Cameroun","S√©n√©gal","Botswana","Zambie"],
      europe:["France","Espagne","Italie","Allemagne","Portugal","Belgique","Suisse","Gr√®ce","Su√®de","Norv√®ge","Danemark","Irlande"],
      asia:["Arabie","Japon","Chine","Inde","Pakistan","Iran","Irak","Syrie","Liban","Qatar","Y√©men","Jordanie"],
      north_america:["Canada","√âtatsUnis","Mexique","Cuba","Ha√Øti","Jama√Øque"],
      south_america:["Br√©sil","Argentine","Chili","P√©rou","Uruguay","Paraguay","Colombie"],
      oceania:["Australie","NouvelleZ√©lande","Fidji","Samoa","Tonga","Kiribati"]},
  en:{africa:["Algeria","Tunisia","Morocco","Libya","Egypt","Sudan","Kenya","Gabon","Benin","Ghana","Mali","Niger","Malawi","Namibia","Mozambique","Togo","Cameroon","Senegal","Botswana","Zambia"],
      europe:["France","Spain","Italy","Germany","Portugal","Belgium","Sweden","Norway","Denmark","Ireland","Greece","Poland"],
      asia:["Saudi","Japan","China","India","Pakistan","Iran","Iraq","Syria","Lebanon","Qatar","Yemen","Jordan"],
      north_america:["Canada","UnitedStates","Mexico","Cuba","Haiti","Jamaica"],
      south_america:["Brazil","Argentina","Chile","Peru","Uruguay","Paraguay","Colombia"],
      oceania:["Australia","NewZealand","Fiji","Samoa","Tonga","Kiribati"]},
  es:{africa:["Argelia","T√∫nez","Marruecos","Libia","Egipto","Sud√°n","Kenia","Gab√≥n","Ben√≠n","Ghana","Mal√≠","N√≠ger","Malaui","Namibia","Mozambique","Togo","Camer√∫n","Senegal","Botsuana","Zambia"],
      europe:["Francia","Espa√±a","Italia","Alemania","Portugal","B√©lgica","Suecia","Noruega","Dinamarca","Irlanda","Grecia","Polonia"],
      asia:["Arabia","Jap√≥n","China","India","Pakist√°n","Ir√°n","Irak","Siria","L√≠bano","Catar","Yemen","Jordania"],
      north_america:["Canad√°","EstadosUnidos","M√©xico","Cuba","Hait√≠","Jamaica"],
      south_america:["Brasil","Argentina","Chile","Per√∫","Uruguay","Paraguay","Colombia"],
      oceania:["Australia","NuevaZelanda","Fiyi","Samoa","Tonga","Kiribati"]},
  ar:{africa:["ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±","ÿ™ŸàŸÜÿ≥","ÿßŸÑŸÖÿ∫ÿ±ÿ®","ŸÑŸäÿ®Ÿäÿß","ŸÖÿµÿ±","ÿßŸÑÿ≥ŸàÿØÿßŸÜ","ŸÉŸäŸÜŸäÿß","ÿßŸÑÿ∫ÿßÿ®ŸàŸÜ","ÿ®ŸÜŸäŸÜ","ÿ∫ÿßŸÜÿß","ŸÖÿßŸÑŸä","ÿßŸÑŸÜŸäÿ¨ÿ±","ŸÖÿßŸÑÿßŸàŸä","ŸÜÿßŸÖŸäÿ®Ÿäÿß","ÿßŸÑŸÖŸàÿ≤ŸÖÿ®ŸäŸÇ","ÿ™Ÿàÿ∫Ÿà","ÿßŸÑŸÉÿßŸÖŸäÿ±ŸàŸÜ","ÿßŸÑÿ≥ŸÜÿ∫ÿßŸÑ","ÿ®Ÿàÿ™ÿ≥ŸàÿßŸÜÿß","ÿ≤ÿßŸÖÿ®Ÿäÿß"],
      europe:["ŸÅÿ±ŸÜÿ≥ÿß","ÿ•ÿ≥ÿ®ÿßŸÜŸäÿß","ÿ•Ÿäÿ∑ÿßŸÑŸäÿß","ÿ£ŸÑŸÖÿßŸÜŸäÿß","ÿßŸÑÿ®ÿ±ÿ™ÿ∫ÿßŸÑ","ÿ®ŸÑÿ¨ŸäŸÉÿß","ÿßŸÑÿ≥ŸàŸäÿØ","ÿßŸÑŸÜÿ±ŸàŸäÿ¨","ÿßŸÑÿØŸÜŸÖÿßÿ±ŸÉ","ÿ•Ÿäÿ±ŸÑŸÜÿØÿß","ÿßŸÑŸäŸàŸÜÿßŸÜ","ÿ®ŸàŸÑŸÜÿØÿß"],
      asia:["ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©","ÿßŸÑŸäÿßÿ®ÿßŸÜ","ÿßŸÑÿµŸäŸÜ","ÿßŸÑŸáŸÜÿØ","ÿ®ÿßŸÉÿ≥ÿ™ÿßŸÜ","ÿ•Ÿäÿ±ÿßŸÜ","ÿßŸÑÿπÿ±ÿßŸÇ","ÿ≥Ÿàÿ±Ÿäÿß","ŸÑÿ®ŸÜÿßŸÜ","ŸÇÿ∑ÿ±","ÿßŸÑŸäŸÖŸÜ","ÿßŸÑÿ£ÿ±ÿØŸÜ"],
      north_america:["ŸÉŸÜÿØÿß","ÿßŸÑŸàŸÑÿßŸäÿßÿ™_ÿßŸÑŸÖÿ™ÿ≠ÿØÿ©","ÿßŸÑŸÖŸÉÿ≥ŸäŸÉ","ŸÉŸàÿ®ÿß","ŸáÿßŸäÿ™Ÿä","ÿ¨ÿßŸÖÿßŸäŸÉÿß"],
      south_america:["ÿßŸÑÿ®ÿ±ÿßÿ≤ŸäŸÑ","ÿßŸÑÿ£ÿ±ÿ¨ŸÜÿ™ŸäŸÜ","ÿ™ÿ¥ŸäŸÑŸä","ÿ®Ÿäÿ±Ÿà","ÿßŸÑÿ£Ÿàÿ±Ÿàÿ∫ŸàÿßŸä","ÿ®ÿßÿ±ÿßÿ∫ŸàÿßŸä","ŸÉŸàŸÑŸàŸÖÿ®Ÿäÿß"],
      oceania:["ÿ£ÿ≥ÿ™ÿ±ÿßŸÑŸäÿß","ŸÜŸäŸàÿ≤ŸäŸÑŸÜÿØÿß","ŸÅŸäÿ¨Ÿä","ÿ≥ÿßŸÖŸàÿß","ÿ™ŸàŸÜÿ∫ÿß","ŸÉŸäÿ±Ÿäÿ®ÿßÿ™Ÿä"]}
};
const LETTERS={fr:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",en:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",es:"ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ",ar:"ÿßÿ®ÿ™ÿ´ÿ¨ÿ≠ÿÆÿØÿ∞ÿ±ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ÿπÿ∫ŸÅŸÇŸÉŸÑŸÖŸÜŸáŸàŸä"};
const titleBy={fr:{africa:"Afrique",europe:"Europe",asia:"Asie",north_america:"Am√©rique du Nord",south_america:"Am√©rique du Sud",oceania:"Oc√©anie"},
              en:{africa:"Africa",europe:"Europe",asia:"Asia",north_america:"North America",south_america:"South America",oceania:"Oceania"},
              es:{africa:"√Åfrica",europe:"Europa",asia:"Asia",north_america:"Am√©rica del Norte",south_america:"Am√©rica del Sur",oceania:"Ocean√≠a"},
              ar:{africa:"ÿ•ŸÅÿ±ŸäŸÇŸäÿß",europe:"ÿ£Ÿàÿ±Ÿàÿ®ÿß",asia:"ÿ¢ÿ≥Ÿäÿß",north_america:"ÿ£ŸÖÿ±ŸäŸÉÿß ÿßŸÑÿ¥ŸÖÿßŸÑŸäÿ©",south_america:"ÿ£ŸÖÿ±ŸäŸÉÿß ÿßŸÑÿ¨ŸÜŸàÿ®Ÿäÿ©",oceania:"ÿ£ŸàŸÇŸäÿßŸÜŸàÿ≥Ÿäÿß"}};

const $=s=>document.querySelector(s);
const grid=$("#grid"), wordsEl=$("#words"), titleBar=$("#titleBar");
const continent=$("#continent"), lang=$("#lang"), size=$("#size"), diag=$("#diag"), rev=$("#rev");
const newBtn=$("#new"), solBtn=$("#toggleSol"), wordsRange=$("#wordsCount"), wordsLabel=$("#wordsCountLabel");
const sound=$("#sound");
wordsRange.addEventListener("input",()=>wordsLabel.textContent=wordsRange.value);

/* Langue & direction */
function syncDir(){ document.body.dir = (lang.value==="ar")?"rtl":"ltr"; document.documentElement.lang = lang.value; }
lang.addEventListener("change",syncDir); syncDir();

/* Accent par continent */
function setAccent(){ const wrap=$("#grid-wrap"); wrap.className=""; wrap.classList.add("cont-"+continent.value); }
continent.addEventListener("change",setAccent); setAccent();

/* AUDIO (click & victoire) */
let actx=null; function ensureCtx(){ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); } return actx; }
function clickSound(){ if(!sound.checked) return; const ac=ensureCtx(), o=ac.createOscillator(), g=ac.createGain();
  o.type="square"; o.frequency.value=880; o.connect(g); g.connect(ac.destination);
  const t=ac.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.25,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.09);
  o.start(t); o.stop(t+0.1);
}
function victorySound(){ if(!sound.checked) return; const ac=ensureCtx(), notes=[880,1175,1568], now=ac.currentTime;
  notes.forEach((f,i)=>{ const o=ac.createOscillator(), g=ac.createGain(); o.type="triangle"; o.frequency.value=f; o.connect(g); g.connect(ac.destination);
    g.gain.setValueAtTime(0.0001, now+0.15*i); g.gain.exponentialRampToValueAtTime(0.35, now+0.15*i+0.03); g.gain.exponentialRampToValueAtTime(0.0001, now+0.15*i+0.25);
    o.start(now+0.15*i); o.stop(now+0.15*i+0.27); });
}

/* Construction de la grille */
let STATE={};
function shuffle(a){for(let i=a.length-1;i>0;i++){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}

function makeGrid(){
  const lg=lang.value, cont=continent.value;
  const N = Math.max(4, parseInt(size.value,10) || 14);
  const allowDiag=diag.checked, allowRev=rev.checked, maxW=Math.max(1, parseInt(wordsRange.value,10) || 20);

  grid.style.setProperty("--N",N);
  grid.innerHTML=""; wordsEl.innerHTML="";

  const pool=(DATA[lg] && DATA[lg][cont]) ? DATA[lg][cont].slice() : [];
  const wordsList=shuffle(pool).slice(0,Math.min(maxW,pool.length));
  const norm=w=> lg==="ar"? w.replace(/\s|_/g,"") : w.replace(/\s|_|-/g,"").toUpperCase();
  const place=wordsList.map(t=>({label:t,norm:norm(t)}));

  const M=Array.from({length:N},()=>Array(N).fill(""));
  const cellsPos={};
  const dirs = allowDiag? [[1,0],[0,1],[1,1],[1,-1],[-1,1],[0,-1],[-1,0],[-1,-1]] : [[1,0],[0,1],[0,-1],[-1,0]];

  function can(word,r,c,dr,dc){
    for(let i=0;i<word.length;i++){
      const rr=r+i*dr, cc=c+i*dc;
      if(rr<0||cc<0||rr>=N||cc>=N) return false;
      const ch=M[rr][cc]; if(ch && ch!==word[i]) return false;
    } return true;
  }
  function put(word,r,c,dr,dc,key){
    const pos=[]; for(let i=0;i<word.length;i++){const rr=r+i*dr,cc=c+i*dc; M[rr][cc]=word[i]; pos.push([rr,cc]);}
    cellsPos[key]=pos;
  }
  for(const w of place){
    let word=w.norm; if(allowRev && Math.random()<.5) word=[...word].reverse().join("");
    let ok=false, tries=0;
    while(!ok && tries<600){
      tries++; const [dr,dc]=dirs[(Math.random()*dirs.length)|0]; const r=(Math.random()*N)|0, c=(Math.random()*N)|0;
      if(can(word,r,c,dr,dc)){ put(word,r,c,dr,dc,w.label); ok=true; }
    }
  }

  const letters=LETTERS[lg] || LETTERS.fr;
  for(let r=0;r<N;r++)for(let c=0;c<N;c++) if(!M[r][c]) M[r][c]=letters[(Math.random()*letters.length)|0];

  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    const d=document.createElement("div"); d.className="cell"; d.dataset.r=r; d.dataset.c=c; d.textContent=M[r][c]; grid.appendChild(d);
  }

  Object.keys(cellsPos).forEach(w=>{const chip=document.createElement("div"); chip.className="chip"; chip.dataset.word=w; chip.textContent=w; wordsEl.appendChild(chip);});

  const t=titleBy[lg][cont]; const lgName={fr:"Fran√ßais",en:"English",es:"Espa√±ol",ar:"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"}[lg]||"";
  titleBar.textContent = t ? `${t} ‚Äî ${lgName}` : lgName;

  STATE={N,M,cellsPos,found:new Set(),start:null,selecting:false,lang:lg};
  bindSelection();
}

/* S√©lection */
function getCell(r,c){return grid.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`)}
function clearSel(){grid.querySelectorAll(".cell.sel").forEach(el=>el.classList.remove("sel"))}
function paintPath(r0,c0,r1,c1){
  clearSel();
  const dr=Math.sign(r1-r0), dc=Math.sign(c1-c0);
  if(!(dr===0||dc===0||Math.abs(r1-r0)===Math.abs(c1-c0))) return;
  const steps=Math.max(Math.abs(r1-r0),Math.abs(c1-c0));
  for(let i=0;i<=steps;i++){const rr=r0+i*dr,cc=c0+i*dc; getCell(rr,cc).classList.add("sel");}
}
function finalizePath(){
  const path=[...grid.querySelectorAll(".cell.sel")]; if(path.length<2){clearSel(); return;}
  let matched=null;
  for(const [label,pos] of Object.entries(STATE.cellsPos)){
    if(pos.length!==path.length) continue;
    let ok=true; for(let i=0;i<pos.length;i++){const [r,c]=pos[i]; if(!(+path[i].dataset.r===r && +path[i].dataset.c===c)){ok=false;break}}
    if(ok){matched=label; break;}
    ok=true; for(let i=0;i<pos.length;i++){const [r,c]=pos[pos.length-1-i]; if(!(+path[i].dataset.r===r && +path[i].dataset.c===c)){ok=false;break}}
    if(ok){matched=label; break;}
  }
  if(matched){
    path.forEach(el=>{el.classList.remove("sel"); el.classList.add("ok");});
    const chip=wordsEl.querySelector(`.chip[data-word="${CSS.escape(matched)}"]`); if(chip) chip.classList.add("ok");
    STATE.found.add(matched);
    clickSound();
    checkWin();
  }else clearSel();
}
function cellFromPoint(x,y){
  const el=document.elementFromPoint(x,y);
  if(!el) return null;
  if(el.classList.contains("cell")) return el;
  return el.closest?.(".cell")||null;
}
function bindSelection(){
  const onMove = (e)=>{
    const p = e.touches? e.touches[0] : e;
    const hit = cellFromPoint(p.clientX, p.clientY);
    if(!STATE.selecting || !hit) return;
    paintPath(STATE.start[0], STATE.start[1], +hit.dataset.r, +hit.dataset.c);
  };
  grid.onpointerdown = (e)=>{
    const el=e.target.closest(".cell"); if(!el) return;
    e.preventDefault(); grid.setPointerCapture?.(e.pointerId);
    STATE.selecting=true; STATE.start=[+el.dataset.r,+el.dataset.c];
    clearSel(); el.classList.add("sel");
    grid.addEventListener("pointermove", onMove, {passive:false});
    grid.addEventListener("touchmove", onMove, {passive:false});
  };
  const end = (e)=>{
    if(!STATE.selecting) return;
    STATE.selecting=false;
    grid.releasePointerCapture?.(e.pointerId);
    grid.removeEventListener("pointermove", onMove);
    grid.removeEventListener("touchmove", onMove);
    const p = e.changedTouches? e.changedTouches[0] : e;
    const hit = cellFromPoint(p.clientX, p.clientY);
    if(hit) paintPath(STATE.start[0], STATE.start[1], +hit.dataset.r, +hit.dataset.c);
    finalizePath();
  };
  grid.onpointerup=end; grid.ontouchend=end; grid.onpointercancel=end;
}

/* Victoire */
function confetti(){
  for(let i=0;i<40;i++){
    const s=document.createElement("span");
    s.textContent=["üéâ","‚ú®","üéä","‚≠ê","üí´"][i%5];
    s.style.position="fixed"; s.style.left=Math.random()*100+"vw"; s.style.top="-10px";
    s.style.fontSize=(16+Math.random()*18)+"px"; s.style.transition="transform 1.2s ease, opacity 1.3s ease"; s.style.opacity="0";
    document.body.appendChild(s);
    requestAnimationFrame(()=>{ s.style.opacity="1"; s.style.transform=`translateY(${(100+Math.random()*120)}vh) rotate(${(Math.random()*720-360)|0}deg)`;});
    setTimeout(()=>s.remove(),1400);
  }
}
function checkWin(){ const total=Object.keys(STATE.cellsPos).length;
  if(STATE.found.size===total && total>0){ confetti(); victorySound(); }
}

/* Solutions */
let showSolutions=false;
document.getElementById("toggleSol").addEventListener("click",()=>{
  showSolutions=!showSolutions;
  const btn=document.getElementById("toggleSol");
  btn.textContent = showSolutions ? "Masquer les solutions" : "Afficher les solutions";
  grid.querySelectorAll(".cell").forEach(el=>el.classList.remove("sol"));
  if(showSolutions){
    for(const pos of Object.values(STATE.cellsPos)){
      pos.forEach(([r,c])=> grid.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`).classList.add("sol"));
    }
  }
});

/* Init */
document.getElementById("new").addEventListener("click", makeGrid);
document.getElementById("wordsCountLabel").textContent = document.getElementById("wordsCount").value;
makeGrid();
</script>
</body>
</html>
