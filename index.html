<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1628" />
  <meta name="application-name" content="EDUFUN" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="EDUFUN" />

  <!-- PWA -->
  <!-- IMPORTANT : pointer vers manifest.json (et non manifeste.webmanifest) -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./assets/icons/edufun-logo-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./assets/icons/edufun-logo-512.png">
  <link rel="apple-touch-icon" href="./assets/icons/edufun-logo-192.png">

  <!-- POLICES locales -->
  <link rel="preload" href="./fonts/NotoKufiArabic-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="./fonts/NotoKufiArabic-Bold.woff2" as="font" type="font/woff2" crossorigin>

  <title>EDUFUN ‚Äî WordSearch</title>

  <style>
  /* Police arabe (activ√©e en RTL) */
  @font-face{
    font-family:"Noto Kufi Arabic";
    src:url("./fonts/NotoKufiArabic-Regular.woff2") format("woff2");
    font-weight:400; font-style:normal; font-display:swap;
  }
  @font-face{
    font-family:"Noto Kufi Arabic";
    src:url("./fonts/NotoKufiArabic-Bold.woff2") format("woff2");
    font-weight:700; font-style:normal; font-display:swap;
  }
  html[lang="ar"], [dir="rtl"], :lang(ar){
    font-family:"Noto Kufi Arabic", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
  }

  /* ===== Th√®me & UI ===== */
  :root{
    --bg:#1B1F38;
    --panel:#222A4A;
    --ink:#ffffff;
    --muted:#AFC7FF;
    --accent:#FFBA08;
    --cell:#2D3A68;
    --cell-sel:#F72585;
    --cell-ok:#3ABF47;
    --border:#4AA3FF;
    --gap:8px; --shell-w:min(92vw,680px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background: radial-gradient(1200px 1200px at 70% -200px, #20305f 0%, #1B1F38 45%, #12162a 100%);
    font-family: Inter, system-ui, "Noto Kufi Arabic", sans-serif;
  }
  body[dir="rtl"]{font-family:"Noto Kufi Arabic", system-ui, sans-serif}

  .container{max-width:980px;margin-inline:auto;padding:16px}
  h1{margin:6px 0 14px;font-size:clamp(20px,3.6vw,34px);letter-spacing:.3px}

  .card{
    background: var(--panel);
    border-radius: 18px;
    padding: 16px;
    box-shadow: 0 8px 28px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
  }

  .controls{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:560px){ .controls{grid-template-columns:1fr} }
  .controls .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{color:var(--muted);font-size:14px}
  select,input[type="range"]{
    background:#0f1733;color:var(--ink);
    border:1px solid #32447a;border-radius:10px;padding:6px 10px
  }
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}

  button{
    background: var(--accent); color: #1B1F38;
    border:0;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer;
    box-shadow: 0 6px 18px rgba(255,186,8,.35);
    transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
  }
  button:hover{ transform: translateY(-1px); filter: saturate(1.1); }
  button:active{ transform: translateY(0); box-shadow:none; }

  .header-bar{
    background: linear-gradient(135deg,#253062 0%, #1f2a54 50%, #1b2448 100%);
    border-radius: 12px; padding: 10px 14px; text-align:center;
    font-weight:800; letter-spacing:.4px; color: var(--muted);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
  }

  .grid-shell{display:flex;justify-content:center}
  #grid-wrap{
    width:var(--shell-w); padding:12px; border:1px solid #2a3a6d; border-radius:14px;
    background:#141d3a; box-shadow: inset 0 0 0 1px rgba(255,255,255,.04); margin:0 auto
  }
  #grid{display:grid;grid-template-columns:repeat(var(--N,6),1fr);gap:var(--gap);width:100%;touch-action:none}

  .cell{
    background:var(--cell); border:1px solid var(--border);
    display:flex; align-items:center; justify-content:center;
    color:#f1f6ff; font-weight:800; aspect-ratio:1/1;
    font-size: clamp(14px, calc(((var(--shell-w) - (var(--N) - 1) * var(--gap)) / var(--N)) * 0.56), 48px);
    line-height:1; user-select:none; -webkit-user-select:none; -webkit-tap-highlight-color: transparent;
    white-space:nowrap; overflow:hidden; letter-spacing:0;
    border-radius:10px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    transition: background .1s, transform .08s, box-shadow .2s, color .2s;
  }
  body[dir="rtl"] .cell{
    font-size: clamp(13px, calc(((var(--shell-w) - (var(--N) - 1) * var(--gap)) / var(--N)) * 0.52), 44px);
  }
  .cell.sel{
    background: var(--cell-sel); border-color: #ff4da0; color: #fff;
    box-shadow: 0 0 0 8px rgba(247,37,133,.15), 0 0 24px rgba(124,195,255,.25) inset;
    animation: pulseSelect .8s ease-out infinite; transform: scale(.98);
  }
  @keyframes pulseSelect{0%{box-shadow:0 0 0 8px rgba(247,37,133,.18)}100%{box-shadow:0 0 0 18px rgba(247,37,133,0)}}
  .cell.ok{
    background: var(--cell-ok); border-color:#3de58e; color:#071b0b;
    box-shadow: 0 0 18px rgba(61,229,142,.35) inset; animation: popFound .35s ease;
  }
  @keyframes popFound { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }
  .cell.sol{outline:3px dashed #ffa726;outline-offset:-6px}

  .words{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;justify-content:center}
  .words .chip{background:#16244a;border:1px dashed #2f4a8a;color:#d4e6ff;padding:8px 12px;border-radius:999px;font-weight:800}
  .words .chip.ok{background:#0f3b24;border-color:#1f9d55;color:#bff6d1}

  /* Bouton Installer */
  #installBtn[hidden]{display:none}
  #installBtn{margin:6px 0 0 0}

  /* Splash overlay custom */
  #splash{
    position:fixed; inset:0; z-index:99999;
    display:flex; align-items:center; justify-content:center;
    background: radial-gradient(1200px 1200px at 70% -200px, #20305f 0%, #1B1F38 45%, #12162a 100%);
  }
  #splash .sbox{
    display:flex; flex-direction:column; align-items:center; gap:14px;
    padding:28px 32px; border-radius:18px; background:rgba(9,15,30,.55);
    box-shadow:0 18px 50px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06)
  }
  #splash .brand{font-weight:1000; letter-spacing:.5px; font-size:28px; color:#fff}
  #splash .hint{font-size:14px; color:#AFC7FF}
  #splash.hide{opacity:0; pointer-events:none; transition:opacity .35s ease}

  /* Canvas de c√©l√©bration (feux + confettis) */
  #celebration-canvas{position:fixed; inset:0; pointer-events:none; z-index:9999}
  </style>

  <script>
    // --- Service Worker (scope correct en local et sur GitHub Pages) ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // si tu h√©berges sur /edufun-wordsearch/, on en tient compte
          const base = location.pathname.includes('/edufun-wordsearch/')
            ? '/edufun-wordsearch/'
            : '/';
          await navigator.serviceWorker.register(base + 'sw.js', { scope: base });
          await navigator.serviceWorker.ready;
        } catch (e) {
          console.warn('SW registration failed:', e);
        }
      });
    }
  </script>
</head>
<body>
  <noscript>
    <div style="max-width:980px;margin:16px auto;padding:12px;border-radius:12px;background:#222A4A;color:#fff">
      EDUFUN n√©cessite JavaScript pour fonctionner.
    </div>
  </noscript>

  <!-- SPLASH SCREEN (dispara√Æt quand la 1√®re grille est pr√™te) -->
  <div id="splash" aria-hidden="true">
    <div class="sbox" role="status" aria-live="polite">
      <img src="./assets/icons/edufun-logo-192.png" alt="Logo EDUFUN" width="96" height="96" />
      <div class="brand">EDUFUN</div>
      <div class="hint">Chargement‚Ä¶</div>
    </div>
  </div>

  <div class="container">
    <h1>üåç EDUFUN ‚Äî WordSearch</h1>

    <div class="card" role="region" aria-label="Param√®tres et grille">
      <div class="controls">
        <div class="row"><label for="continent">Continent :</label>
          <select id="continent" aria-label="Continent">
            <option value="africa">Afrique</option>
            <option value="europe">Europe</option>
            <option value="asia">Asie</option>
            <option value="north_america">Am√©rique du Nord</option>
            <option value="south_america">Am√©rique du Sud</option>
            <option value="oceania">Oc√©anie</option>
          </select>
        </div>
        <div class="row"><label for="lang">Langue :</label>
          <select id="lang" aria-label="Langue">
            <option value="fr">Fran√ßais</option>
            <option value="en">English</option>
            <option value="es">Espa√±ol</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          </select>
        </div>
        <div class="row"><label for="size">Taille :</label>
          <select id="size" aria-label="Taille de la grille">
            <option selected>6</option><option>8</option><option>10</option><option>12</option>
          </select>
        </div>
        <div class="row">
          <label><input type="checkbox" id="diag" checked> diagonales</label>
          <label><input type="checkbox" id="rev" checked> mots invers√©s</label>
        </div>
        <div class="row">
          <label><input type="checkbox" id="sound" checked> son (click)</label>
        </div>
        <div class="row">
          <label for="wordsCount">Mots :</label>
          <input id="wordsCount" type="range" min="4" max="24" value="20" aria-labelledby="wordsCountLabel">
          <span id="wordsCountLabel" aria-live="polite">20</span>
        </div>
      </div>

      <div class="actions">
        <button id="new">Nouvelle grille</button>
        <button id="toggleSol">Afficher les solutions</button>
        <button id="installBtn" hidden>Installer l'application</button>
      </div>

      <div id="titleBar" class="header-bar" role="heading" aria-level="2">‚Äî</div>

      <div class="grid-shell">
        <div id="grid-wrap" class="cont-africa">
          <div id="grid" style="--N:6"></div>
          <div id="words" class="words" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======== Donn√©es ======== */
const DATA = {
  fr:{africa:["Alg√©rie","Tunisie","Maroc","Libye","√âgypte","Soudan","Kenya","Gabon","B√©nin","Ghana","Mali","Niger","Malawi","Namibie","Mozambique","Togo","Cameroun","S√©n√©gal","Botswana","Zambie"],
      europe:["France","Espagne","Italie","Allemagne","Portugal","Belgique","Suisse","Gr√®ce","Su√®de","Norv√®ge","Danemark","Irlande"],
      asia:["Arabie","Japon","Chine","Inde","Pakistan","Iran","Irak","Syrie","Liban","Qatar","Y√©men","Jordanie"],
      north_america:["Canada","√âtatsUnis","Mexique","Cuba","Ha√Øti","Jama√Øque"],
      south_america:["Br√©sil","Argentine","Chili","P√©rou","Uruguay","Paraguay","Colombie"],
      oceania:["Australie","NouvelleZ√©lande","Fidji","Samoa","Tonga","Kiribati"]},
  en:{africa:["Algeria","Tunisia","Morocco","Libya","Egypt","Sudan","Kenya","Gabon","Benin","Ghana","Mali","Niger","Malawi","Namibia","Mozambique","Togo","Cameroon","Senegal","Botswana","Zambia"],
      europe:["France","Spain","Italy","Germany","Portugal","Belgium","Sweden","Norway","Denmark","Ireland","Greece","Poland"],
      asia:["Saudi","Japan","China","India","Pakistan","Iran","Iraq","Syria","Lebanon","Qatar","Yemen","Jordan"],
      north_america:["Canada","UnitedStates","Mexico","Cuba","Haiti","Jamaica"],
      south_america:["Brazil","Argentina","Chile","Peru","Uruguay","Paraguay","Colombia"],
      oceania:["Australia","NewZealand","Fiji","Samoa","Tonga","Kiribati"]},
  es:{africa:["Argelia","T√∫nez","Marruecos","Libia","Egipto","Sud√°n","Kenia","Gab√≥n","Ben√≠n","Ghana","Mal√≠","N√≠ger","Malaui","Namibia","Mozambique","Togo","Camer√∫n","Senegal","Botsuana","Zambia"],
      europe:["Francia","Espa√±a","Italia","Alemania","Portugal","B√©lgica","Suecia","Noruega","Dinamarca","Irlanda","Grecia","Polonia"],
      asia:["Arabia","Jap√≥n","China","India","Pakist√°n","Ir√°n","Irak","Siria","L√≠bano","Catar","Yemen","Jordania"],
      north_america:["Canad√°","EstadosUnidos","M√©xico","Cuba","Hait√≠","Jamaica"],
      south_america:["Brasil","Argentina","Chile","Per√∫","Uruguay","Paraguay","Colombia"],
      oceania:["Australia","NuevaZelanda","Fiyi","Samoa","Tonga","Kiribati"]},
  ar:{africa:["ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±","ÿ™ŸàŸÜÿ≥","ÿßŸÑŸÖÿ∫ÿ±ÿ®","ŸÑŸäÿ®Ÿäÿß","ŸÖÿµÿ±","ÿßŸÑÿ≥ŸàÿØÿßŸÜ","ŸÉŸäŸÜŸäÿß","ÿßŸÑÿ∫ÿßÿ®ŸàŸÜ","ÿ®ŸÜŸäŸÜ","ÿ∫ÿßŸÜÿß","ŸÖÿßŸÑŸä","ÿßŸÑŸÜŸäÿ¨ÿ±","ŸÖÿßŸÑÿßŸàŸä","ŸÜÿßŸÖŸäÿ®Ÿäÿß","ÿßŸÑŸÖŸàÿ≤ŸÖÿ®ŸäŸÇ","ÿ™Ÿàÿ∫Ÿà","ÿßŸÑŸÉÿßŸÖŸäÿ±ŸàŸÜ","ÿßŸÑÿ≥ŸÜÿ∫ÿßŸÑ","ÿ®Ÿàÿ™ÿ≥ŸàÿßŸÜÿß","ÿ≤ÿßŸÖÿ®Ÿäÿß"],
      europe:["ŸÅÿ±ŸÜÿ≥ÿß","ÿ•ÿ≥ÿ®ÿßŸÜŸäÿß","ÿ•Ÿäÿ∑ÿßŸÑŸäÿß","ÿ£ŸÑŸÖÿßŸÜŸäÿß","ÿßŸÑÿ®ÿ±ÿ™ÿ∫ÿßŸÑ","ÿ®ŸÑÿ¨ŸäŸÉÿß","ÿßŸÑÿ≥ŸàŸäÿØ","ÿßŸÑŸÜÿ±ŸàŸäÿ¨","ÿßŸÑÿØŸÜŸÖÿßÿ±ŸÉ","ÿ•Ÿäÿ±ŸÑŸÜÿØÿß","ÿßŸÑŸäŸàŸÜÿßŸÜ","ÿ®ŸàŸÑŸÜÿØÿß"],
      asia:["ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©","ÿßŸÑŸäÿßÿ®ÿßŸÜ","ÿßŸÑÿµŸäŸÜ","ÿßŸÑŸáŸÜÿØ","ÿ®ÿßŸÉÿ≥ÿ™ÿßŸÜ","ÿ•Ÿäÿ±ÿßŸÜ","ÿßŸÑÿπÿ±ÿßŸÇ","ÿ≥Ÿàÿ±Ÿäÿß","ŸÑÿ®ŸÜÿßŸÜ","ŸÇÿ∑ÿ±","ÿßŸÑŸäŸÖŸÜ","ÿßŸÑÿ£ÿ±ÿØŸÜ"],
      north_america:["ŸÉŸÜÿØÿß","ÿßŸÑŸàŸÑÿßŸäÿßÿ™_ÿßŸÑŸÖÿ™ÿ≠ÿØÿ©","ÿßŸÑŸÖŸÉÿ≥ŸäŸÉ","ŸÉŸàÿ®ÿß","ŸáÿßŸäÿ™Ÿä","ÿ¨ÿßŸÖÿßŸäŸÉÿß"],
      south_america:["ÿßŸÑÿ®ÿ±ÿßÿ≤ŸäŸÑ","ÿßŸÑÿ£ÿ±ÿ¨ŸÜÿ™ŸäŸÜ","ÿ™ÿ¥ŸäŸÑŸä","ÿ®Ÿäÿ±Ÿà","ÿßŸÑÿ£Ÿàÿ±Ÿàÿ∫ŸàÿßŸä","ÿ®ÿßÿ±ÿßÿ∫ŸàÿßŸä","ŸÉŸàŸÑŸàŸÖÿ®Ÿäÿß"],
      oceania:["ÿ£ÿ≥ÿ™ÿ±ÿßŸÑŸäÿß","ŸÜŸäŸàÿ≤ŸäŸÑŸÜÿØÿß","ŸÅŸäÿ¨Ÿä","ÿ≥ÿßŸÖŸàÿß","ÿ™ŸàŸÜÿ∫ÿß","ŸÉŸäÿ±Ÿäÿ®ÿßÿ™Ÿä"]}
};
const LETTERS={fr:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",en:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",es:"ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ",ar:"ÿßÿ®ÿ™ÿ´ÿ¨ÿ≠ÿÆÿØÿ∞ÿ±ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ÿπÿ∫ŸÅŸÇŸÉŸÑŸÖŸÜŸáŸàŸä"};
const titleBy={fr:{africa:"Afrique",europe:"Europe",asia:"Asie",north_america:"Am√©rique du Nord",south_america:"Am√©rique du Sud",oceania:"Oc√©anie"},
              en:{africa:"Africa",europe:"Europe",asia:"Asia",north_america:"North America",south_america:"South America",oceania:"Oceania"},
              es:{africa:"√Åfrica",europe:"Europa",asia:"Asia",north_america:"Am√©rica du Nord",south_america:"Am√©rica du Sud",oceania:"Ocean√≠a"},
              ar:{africa:"ÿ•ŸÅÿ±ŸäŸÇŸäÿß",europe:"ÿ£Ÿàÿ±Ÿàÿ®ÿß",asia:"ÿ¢ÿ≥Ÿäÿß",north_america:"ÿ£ŸÖÿ±ŸäŸÉÿß ÿßŸÑÿ¥ŸÖÿßŸÑŸäÿ©",south_america:"ÿ£ŸÖÿ±ŸäŸÉÿß ÿßŸÑÿ¨ŸÜŸàÿ®Ÿäÿ©",oceania:"ÿ£ŸàŸÇŸäÿßŸÜŸàÿ≥Ÿäÿß"}};

const $=s=>document.querySelector(s);
const grid=$("#grid"), wordsEl=$("#words"), titleBar=$("#titleBar");
const continent=$("#continent"), lang=$("#lang"), size=$("#size"), diag=$("#diag"), rev=$("#rev");
const newBtn=$("#new"), solBtn=$("#toggleSol"), wordsRange=$("#wordsCount"), wordsLabel=$("#wordsCountLabel");
const sound=$("#sound");
wordsRange.addEventListener("input",()=>wordsLabel.textContent=wordsRange.value);

/* Langue & direction */
function syncDir(){ document.body.dir = (lang.value==="ar")?"rtl":"ltr"; document.documentElement.lang = lang.value; }
lang.addEventListener("change",syncDir); syncDir();

/* Accent par continent */
function setAccent(){ const wrap=$("#grid-wrap"); wrap.className=""; wrap.classList.add("cont-"+continent.value); }
continent.addEventListener("change",setAccent); setAccent();

/* AUDIO */
let actx=null; function ensureCtx(){ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); } return actx; }
function clickSound(){ if(!sound.checked) return; const ac=ensureCtx(), o=ac.createOscillator(), g=ac.createGain();
  o.type="square"; o.frequency.value=880; o.connect(g); g.connect(ac.destination);
  const t=ac.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.25,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.09);
  o.start(t); o.stop(t+0.1);
}

/* ===== Festivit√©s de victoire ===== */
let fwCanvas, fwCtx, fwRaf;
function ensureFireCanvas(){
  if (fwCanvas) return;
  fwCanvas = document.createElement('canvas');
  fwCanvas.id = 'celebration-canvas';
  document.body.appendChild(fwCanvas);
  fwCtx = fwCanvas.getContext('2d');
  const resize = ()=>{ fwCanvas.width = innerWidth; fwCanvas.height = innerHeight; };
  addEventListener('resize', resize); resize();
}
function spawnParticles(x, y, color, count=90, speed=7){
  const parts = [];
  for (let i=0;i<count;i++){
    const a = Math.random()*Math.PI*2;
    const v = (0.5+Math.random())*speed;
    parts.push({x, y, vx:Math.cos(a)*v, vy:Math.sin(a)*v-(Math.random()*2), life:60+Math.random()*40, r:2+Math.random()*3, color});
  }
  return parts;
}
function runFireworks(){
  ensureFireCanvas();
  const ctx = fwCtx, W = fwCanvas.width, H = fwCanvas.height;
  let particles = [];
  const colors = ['#FFBA08','#F72585','#3ABF47','#4AA3FF','#FB5607','#B5179E'];
  for (let k=0;k<3;k++){
    const cx = Math.random()*W*0.8 + W*0.1;
    const cy = Math.random()*H*0.4 + H*0.1;
    const col = colors[(Math.random()*colors.length)|0];
    particles.push(...spawnParticles(cx, cy, col, 120, 7));
  }
  for (let i=0;i<220;i++){
    const x = Math.random()*W, y = -20*Math.random();
    const col = colors[i % colors.length];
    particles.push({x,y,vx:(Math.random()*2-1)*1.4,vy:2+Math.random()*3,life:120+Math.random()*80,r:2+Math.random()*2,color:col});
  }
  cancelAnimationFrame(fwRaf);
  (function tick(){
    fwRaf = requestAnimationFrame(tick);
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.vx *= 0.995; p.life -= 1;
      ctx.save(); ctx.globalAlpha = Math.max(0, p.life/150); ctx.fillStyle = p.color;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill(); ctx.restore();
    });
    particles = particles.filter(p=>p.life>0 && p.y < H+50);
    if (!particles.length) cancelAnimationFrame(fwRaf);
  })();
}
function victorySound(){
  if(!sound?.checked) return;
  const AC = (window.AudioContext||window.webkitAudioContext);
  if(!AC) return;
  const ac = (window._ac || (window._ac = new AC()));
  const now=ac.currentTime, tones=[880,1175,1568];
  tones.forEach((f,i)=>{ const o=ac.createOscillator(), g=ac.createGain();
    o.type="triangle"; o.frequency.value=f; o.connect(g); g.connect(ac.destination);
    g.gain.setValueAtTime(0.0001, now+0.15*i);
    g.gain.exponentialRampToValueAtTime(0.35, now+0.15*i+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.15*i+0.25);
    o.start(now+0.15*i); o.stop(now+0.15*i+0.27);
  });
}
function bigVictoryJingle(){
  if(!sound?.checked) return;
  const AC = (window.AudioContext||window.webkitAudioContext);
  if(!AC) return;
  const ac = (window._ac || (window._ac = new AC()));
  const base = ac.currentTime, notes = [523,659,784,1046,880,988,1175];
  notes.forEach((f,i)=>{ const o=ac.createOscillator(), g=ac.createGain();
    o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(ac.destination);
    const t = base + i*0.12; g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.35,t+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.28);
    o.start(t); o.stop(t+0.3);
  });
}
function checkWin(){
  const total = Object.keys(STATE.cellsPos||{}).length;
  if (STATE._won || !total) return;
  if (STATE.found?.size === total){
    STATE._won = true;
    victorySound();
    bigVictoryJingle();
    runFireworks();
    setTimeout(()=>{ STATE._won=false; }, 2500);
  }
}

/* Utils */
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a};

/* Construction de la grille */
let STATE={};

function makeGrid(){
  const lg=(lang?.value||'fr').toLowerCase();
  const cont=continent?.value||'africa';
  const N = clamp(parseInt(size?.value,10)||6, 4, 12);   // d√©marre et borne √† 12 max
  const allowDiag=!!diag?.checked, allowRev=!!rev?.checked;
  const maxW= clamp(parseInt(wordsRange?.value,10)||20, 4, 50);

  grid?.style.setProperty("--N",N);
  if(grid) grid.innerHTML="";
  if(wordsEl) wordsEl.innerHTML="";

  const pool=(DATA[lg] && DATA[lg][cont]) ? DATA[lg][cont].slice() : [];
  if(!pool.length){ console.error("Pas de mots pour", lg, cont); return; }

  const wordsList=shuffle(pool).slice(0,Math.min(maxW,pool.length));
  const norm=w=> lg==="ar"? w.replace(/\s|_/g,"") : w.replace(/\s|_|-/g,"").toUpperCase();
  const place=wordsList.map(t=>({label:t,norm:norm(t)}));

  const M=Array.from({length:N},()=>Array(N).fill(""));
  const cellsPos={};
  const dirs = allowDiag? [[1,0],[0,1],[1,1],[1,-1],[-1,1],[0,-1],[-1,0],[-1,-1]] : [[1,0],[0,1],[0,-1],[-1,0]];

  function can(word,r,c,dr,dc){
    for(let i=0;i<word.length;i++){
      const rr=r+i*dr, cc=c+i*dc;
      if(rr<0||cc<0||rr>=N||cc>=N) return false;
      const ch=M[rr][cc]; if(ch && ch!==word[i]) return false;
    } return true;
  }
  function put(word,r,c,dr,dc,key){
    const pos=[]; for(let i=0;i<word.length;i++){const rr=r+i*dr,cc=c+i*dc; M[rr][cc]=word[i]; pos.push([rr,cc]);}
    cellsPos[key]=pos;
  }
  for(const w of place){
    let word=w.norm; if(allowRev && Math.random()<.5) word=[...word].reverse().join("");
    let ok=false, tries=0;
    while(!ok && tries<600){
      tries++; const [dr,dc]=dirs[(Math.random()*dirs.length)|0]; const r=(Math.random()*N)|0, c=(Math.random()*N)|0;
      if(can(word,r,c,dr,dc)){ put(word,r,c,dr,dc,w.label); ok=true; }
    }
  }

  const letters=LETTERS[lg] || LETTERS.fr;
  for(let r=0;r<N;r++)for(let c=0;c<N)c++) if(!M[r][c]) M[r][c]=letters[(Math.random()*letters.length)|0];

  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    const d=document.createElement("div"); d.className="cell"; d.dataset.r=r; d.dataset.c=c; d.textContent=M[r][c]; grid.appendChild(d);
  }

  Object.keys(cellsPos).forEach(w=>{
    const chip=document.createElement("div"); chip.className="chip"; chip.dataset.word=w; chip.textContent=w; wordsEl.appendChild(chip);
  });

  const t=titleBy[lg][cont]; const lgName={fr:"Fran√ßais",en:"English",es:"Espa√±ol",ar:"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"}[lg]||"";
  titleBar.textContent = t ? `${t} ‚Äî ${lgName}` : lgName;

  STATE={N,M,cellsPos,found:new Set(),start:null,selecting:false,lang:lg,_won:false};
  bindSelection();

  // cacher le splash (premi√®re grille pr√™te)
  requestAnimationFrame(()=> setTimeout(()=>{
    const sp=document.getElementById('splash');
    if(sp){ sp.classList.add('hide'); setTimeout(()=>sp.remove(), 450); }
  }, 250));
}

/* S√©lection */
function getCell(r,c){return grid.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`)}
function clearSel(){grid.querySelectorAll(".cell.sel").forEach(el=>el.classList.remove("sel"))}
function cellFromPoint(x,y){
  const el=document.elementFromPoint(x,y);
  if(!el) return null;
  if(el.classList.contains("cell")) return el;
  return el.closest?.(".cell")||null;
}
function paintPath(r0,c0,r1,c1){
  clearSel();
  const dr=Math.sign(r1-r0), dc=Math.sign(c1-c0);
  if(!(dr===0||dc===0||Math.abs(r1-r0)===Math.abs(c1-c0))) return;
  const steps=Math.max(Math.abs(r1-r0),Math.abs(c1-c0));
  for(let i=0;i<=steps;i++){const rr=r0+i*dr,cc=c0+i*dc; getCell(rr,cc).classList.add("sel");}
}
function finalizePath(){
  const path=[...grid.querySelectorAll(".cell.sel")]; if(path.length<2){clearSel(); return;}
  let matched=null;
  for(const [label,pos] of Object.entries(STATE.cellsPos)){
    if(pos.length!==path.length) continue;
    let ok=true; for(let i=0;i<pos.length;i++){const [r,c]=pos[i]; if(!(+path[i].dataset.r===r && +path[i].dataset.c===c)){ok=false;break}}
    if(ok){matched=label; break;}
    ok=true; for(let i=0;i<pos.length;i++){const [r,c]=pos[pos.length-1-i]; if(!(+path[i].dataset.r===r && +path[i].dataset.c===c)){ok=false;break}}
    if(ok){matched=label; break;}
  }
  if(matched){
    path.forEach(el=>{el.classList.remove("sel"); el.classList.add("ok");});
    const chip=wordsEl.querySelector(`.chip[data-word="${CSS.escape(matched)}"]`); if(chip) chip.classList.add("ok");
    STATE.found.add(matched);
    clickSound();
    checkWin(); // <<< important
  }else clearSel();
}
function bindSelection(){
  const onMove = (e)=>{
    const p = e.touches? e.touches[0] : e;
    const hit = cellFromPoint(p.clientX, p.clientY);
    if(!STATE.selecting || !hit) return;
    paintPath(STATE.start[0], STATE.start[1], +hit.dataset.r, +hit.dataset.c);
  };
  grid.onpointerdown = (e)=>{
    const el=e.target.closest(".cell"); if(!el) return;
    e.preventDefault(); grid.setPointerCapture?.(e.pointerId);
    STATE.selecting=true; STATE.start=[+el.dataset.r,+el.dataset.c];
    clearSel(); el.classList.add("sel");
    grid.addEventListener("pointermove", onMove, {passive:false});
    grid.addEventListener("touchmove", onMove, {passive:false});
  };
  const end = (e)=>{
    if(!STATE.selecting) return;
    STATE.selecting=false; grid.releasePointerCapture?.(e.pointerId);
    grid.removeEventListener("pointermove", onMove);
    grid.removeEventListener("touchmove", onMove);
    const p = e.changedTouches? e.changedTouches[0] : e;
    const hit = cellFromPoint(p.clientX, p.clientY);
    if(hit) paintPath(STATE.start[0], STATE.start[1], +hit.dataset.r, +hit.dataset.c);
    finalizePath();
  };
  grid.onpointerup=end; grid.ontouchend=end; grid.onpointercancel=end;
}

/* Solutions */
let showSolutions=false;
document.getElementById("toggleSol").addEventListener("click",()=>{
  showSolutions=!showSolutions;
  const btn=document.getElementById("toggleSol");
  btn.textContent = showSolutions ? "Masquer les solutions" : "Afficher les solutions";
  grid.querySelectorAll(".cell").forEach(el=>el.classList.remove("sol"));
  if(showSolutions){
    for(const pos of Object.values(STATE.cellsPos)){
      pos.forEach(([r,c])=> grid.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`).classList.add("sol"));
    }
  }
});

/* Bouton Installer (PWA) */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  if (btn) btn.hidden = false;
});
document.getElementById('installBtn')?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  const btn = document.getElementById('installBtn');
  if (btn) btn.hidden = true;
  await deferredPrompt.prompt();
  try { await deferredPrompt.userChoice; } finally { deferredPrompt = null; }
});
window.addEventListener('appinstalled', () => {
  const btn = document.getElementById('installBtn');
  if (btn) btn.hidden = true;
});

/* Init */
document.getElementById("new").addEventListener("click", makeGrid);
document.getElementById("wordsCountLabel").textContent = document.getElementById("wordsCount").value;
makeGrid(); // => cache le splash quand pr√™t
</script>
</body>
</html>
